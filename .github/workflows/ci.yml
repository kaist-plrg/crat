name: CI

on:
  push:

defaults:
  run:
    shell: bash

jobs:
  test:
    name: test

    runs-on: ubuntu-22.04

    container:
      image: kaistplrg/crat-test:1.1.2

    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Change owner
        run: chown -R ubuntu:ubuntu .

      - name: Check formatting
        run: sudo -u ubuntu bash -lc "cargo fmt --check"
      - name: Apply lints
        run: sudo -u ubuntu bash -lc "cargo clippy -- -D warnings"

      - name: Build dependency crate
        run: sudo -u ubuntu bash -lc "cd deps_crate && cargo build"

      - name: Build (Dev)
        run: sudo -u ubuntu bash -lc "cargo build"
      - name: Test (Dev)
        run: sudo -u ubuntu bash -lc "cargo test"

      - name: Build (Release)
        run: sudo -u ubuntu bash -lc "cargo build --release"
      - name: Test (Release)
        run: sudo -u ubuntu bash -lc "cargo test --release"

      - name: Benchmark (Transformation) - resolve
        run: sudo -u ubuntu bash -lc "./tool.py transform resolve"
      - name: Benchmark (Build) - resolve
        run: sudo -u ubuntu bash -lc "./tool.py build resolve"
      - name: Benchmark (Test) - resolve
        run: sudo -u ubuntu bash -lc "./tool.py test resolve --exclude tar-1.34"
      - name: Benchmark (Clean) - resolve
        run: sudo -u ubuntu bash -lc "rm -rf benchmarks/rs-resolved/*/target"

      - name: Benchmark (Transformation) - io
        run: sudo -u ubuntu bash -lc "./tool.py transform io --exclude axel,zmap"
      - name: Benchmark (Build) - io
        run: sudo -u ubuntu bash -lc "./tool.py build io --exclude axel,zmap"
      - name: Benchmark (Test) - io
        run: sudo -u ubuntu bash -lc "./tool.py test io --exclude axel,zmap,snoopy,streem,tar-1.34,the_silver_searcher,tulipindicators"
      - name: Benchmark (Clean) - io
        run: sudo -u ubuntu bash -lc "rm -rf benchmarks/rs-io/*/target"

      - name: Benchmark (Transformation) - expand
        run: sudo -u ubuntu bash -lc "./tool.py transform expand-resolve"
      - name: Benchmark (Build) - expand
        run: sudo -u ubuntu bash -lc "./tool.py build expand-resolve"
      - name: Benchmark (Test) - expand
        run: sudo -u ubuntu bash -lc "./tool.py test expand-resolve --exclude tar-1.34"
      - name: Benchmark (Clean) - expand
        run: sudo -u ubuntu bash -lc "rm -rf benchmarks/rs-expand-resolve/*/target"
