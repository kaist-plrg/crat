# Crat

**C**-to-**R**ust **A**utomatic **T**ranslator

## Benchmarks

Benchmark programs are under `benchmarks/rs`. Each directory corresponds to each
benchmark and contains Rust code generated by C2Rust. You can run Crat to
transform the benchmark programs.

`tool.py` is a Python script that allows you to easily transform the benchmarks,
build the transformed code, and run their test suites. It can be executed with a
command of the following form:

```bash
`./tool.py <command> <stage> <benchmark>`
```

The command can be one of the following:

* `transform`: Transform the benchmark program(s).
* `build`: Build the transformed benchmark program(s).
* `test`: Run the test suite of the transformed benchmark program(s).
* `clean`: Remove the transformed benchmark program(s).

The stage specifies the directories being the source and the destination of the
transformation and also the passes to be applied. The following stages are
available:

* `resolve`: From `rs` to `rs-resolved` by applying `preprocess,extern,bin`.
* `io`: From `rs-resolved` to `rs-io` by applying `io`.
* `union`: From `rs-resolved` to `rs-union` by applying `union`.
* `union-io`: From `rs-union` to `rs-union-io` by applying `io`.

The benchmark is the name of the benchmark program to be processed, which is the
name of the directory under `benchmarks/rs`. If the given name does not match
any of them, any benchmark whose name starts with the given name will be
processed. If no benchmark is specified, all benchmarks will be processed.

### Transform

The following command transforms `avl` to the `resolve` stage:

```bash
./tool.py transform resolve avl
```

This will not transform the code if `benchmarks/rs-resolved/avl` already exists.
To overwrite the existing code, use the `--overwrite` option:

```bash
./tool.py transform resolve avl --overwrite
```

`tool.py` runs Crat in the release mode by default. If you want to run it in the
debug mode, you need to set the `DEBUG` environment variable:

```bash
DEBUG=1 ./tool.py transform resolve avl
```

This would be useful when inspecting the stack traces or frequently re-compiling
Crat during development.

If the stage depends on another stage, the `tool.py` will automatically
transform the required stage first if it has not been transformed yet. For
example, the following command transforms `avl` to the `resolve` stage if
necessary, and then transforms it to the `io` stage:

```bash
./tool.py transform io avl
```

Note that the `--overwrite` option only applies to the last stage by default.
Therefore, the following command never overwrites the `resolve` stage:

```bash
./tool.py transform io avl --overwrite
```

To overwrite other stages, you can increase the depth by using the
`--overwrite-depth` option:

```bash
./tool.py transform io avl --overwrite --overwrite-depth 2
```

The default depth is 1, and any positive integer is allowed. When `max` is
given, all stages will be overwritten:

```bash
./tool.py transform io avl --overwrite --overwrite-depth max
```

### Build

The following command builds the transformed `avl` in the `resolve` stage:

```bash
./tool.py build resolve avl
```

This will automatically transform `avl` to the `resolve` stage if it has not
been transformed yet. To overwrite the existing code, use the `--overwrite`
option:

```bash
./tool.py build resolve avl --overwrite
```

`tool.py` builds the transformed code in the release mode by default. If you
want to build it in the debug mode, use the `--debug` option:

```bash
./tool.py build resolve avl --debug
```

### Test

The following command runs the test suite of the transformed `avl` in the
`resolve` stage:

```bash
./tool.py test resolve avl
```

As in `build`, `--overwrite` and `--debug` options can be used.

### Clean

The following command remove the transformed `avl` in the `resolve` stage:

```bash
./tool.py clean resolve avl
```

When multiple benchmarks are to be cleaned at once, a confirmation prompt will
be displayed before removing them. To skip the confirmation, use the `--yes` or
`-y` option:

```bash
./tool.py clean resolve --yes
```
